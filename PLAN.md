# План реализации функций для кнопок AI-анализа

## Цель
Реализовать три функции AI-анализа статей через OpenRouter API:
- "О чем статья?" - краткое описание содержания статьи
- "Тезисы" - извлечение основных тезисов статьи
- "Пост для Telegram" - создание поста для Telegram на основе статьи

## Текущее состояние проекта
- ✅ Реализован парсинг статей (извлечение заголовка, даты, контента)
- ✅ Реализована функция перевода через OpenRouter API (модель Deepseek)
- ✅ Распарсенные данные сохраняются в state компонента
- ⏳ Три кнопки AI-анализа пока имеют заглушку (setTimeout)

## План действий

### Этап 1: Создание универсального API route для AI-анализа
**Файл:** `app/api/analyze/route.ts`

1. Создать новый API route `/api/analyze`
2. Принимать параметры:
   - `text` - текст статьи для анализа
   - `action` - тип действия ("summary", "theses", "telegram")
3. Использовать OpenRouter API с моделью `deepseek/deepseek-chat`
4. Читать API ключ из `process.env.OPENROUTER_API_KEY`
5. Формировать разные промпты в зависимости от типа действия:
   - **"summary"** (О чем статья?): 
     - Промпт: "Напиши краткое описание статьи на русском языке (2-3 предложения). О чем эта статья?"
   - **"theses"** (Тезисы):
     - Промпт: "Извлеки основные тезисы из статьи и представь их в виде нумерованного списка на русском языке."
   - **"telegram"** (Пост для Telegram):
     - Промпт: "Создай пост для Telegram на русском языке на основе статьи. Пост должен быть интересным, информативным и подходить для социальной сети. Включи эмодзи и хештеги."
6. Обработать ошибки (401, 403, и т.д.)
7. Вернуть результат в формате JSON: `{ result: string }`

### Этап 2: Обновление функции handleAction в компоненте
**Файл:** `app/page.tsx`

1. Изменить функцию `handleAction` для работы с реальным API:
   - Убрать `setTimeout` (заглушку)
   - Проверять наличие `parsedData` перед отправкой запроса
   - Если данных нет, показывать предупреждение о необходимости сначала распарсить статью
2. Маппинг действий на типы для API:
   - "О чем статья?" → `action: "summary"`
   - "Тезисы" → `action: "theses"`
   - "Пост для Telegram" → `action: "telegram"`
3. Формировать текст для отправки:
   - Использовать `parsedData.title`, `parsedData.date`, `parsedData.content`
   - Формат: `Заголовок: {title}\n\nДата: {date}\n\nКонтент:\n{content}`
4. Отправлять POST запрос на `/api/analyze` с параметрами:
   - `text`: полный текст статьи
   - `action`: тип действия
5. Обрабатывать ответ и отображать результат в поле результата
6. Обрабатывать ошибки и показывать понятные сообщения

### Этап 3: Тестирование и оптимизация

1. Протестировать каждую функцию отдельно:
   - Проверить работу "О чем статья?" на разных статьях
   - Проверить работу "Тезисы" на статьях разной длины
   - Проверить работу "Пост для Telegram" на различных типах контента
2. Оптимизировать промпты для лучших результатов:
   - Возможно, добавить примеры в промпты
   - Настроить `temperature` для разных типов задач
3. Добавить валидацию:
   - Проверка минимальной длины контента
   - Проверка наличия всех необходимых данных
4. Улучшить UX:
   - Показывать прогресс загрузки
   - Добавить возможность отмены запроса
   - Кэшировать результаты для уже обработанных статей

### Этап 4: Обработка ошибок и edge cases

1. Обработать случаи, когда:
   - Статья слишком короткая для анализа
   - Статья слишком длинная (возможно, разбить на части)
   - API вернул ошибку (401, 403, 500)
   - Сетевая ошибка
2. Добавить fallback-механизмы:
   - Повтор запроса при временных ошибках
   - Альтернативные модели, если основная недоступна

## Технические детали

### Используемые технологии:
- **Next.js 14+** (App Router)
- **OpenRouter API** (https://openrouter.ai)
- **Модель:** `deepseek/deepseek-chat`
- **TypeScript**

### Структура запроса к OpenRouter:
```typescript
{
  model: 'deepseek/deepseek-chat',
  messages: [
    {
      role: 'system',
      content: 'Системный промпт в зависимости от типа действия'
    },
    {
      role: 'user',
      content: 'Текст статьи с контекстом'
    }
  ],
  temperature: 0.3-0.7 (в зависимости от задачи)
}
```

### Ожидаемый формат ответа:
```typescript
{
  result: string // Текст результата анализа
}
```

## Порядок реализации

1. **Сначала:** Создать API route `/api/analyze` с базовой функциональностью
2. **Затем:** Обновить `handleAction` для работы с реальным API
3. **После:** Протестировать все три функции
4. **В конце:** Оптимизировать промпты и добавить обработку ошибок

## Примечания

- Все функции используют один и тот же API endpoint для упрощения поддержки
- Промпты можно будет легко изменить без изменения кода
- Результаты не кэшируются на клиенте (можно добавить позже при необходимости)
- Все функции работают только после парсинга статьи (требуется `parsedData`)

